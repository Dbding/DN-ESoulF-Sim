<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>紋章鑄魂模擬</title>
    
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 引入字體 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+TC:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        /* * 全局設置 (字體, 背景, 手機友善):
         * NEW: 基礎字體縮小為 15px，更緊湊。
         */
        html {
            font-size: 15px; /* NEW: 15px (原 16px) */
        }
        
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6; /* gray-100 */
            color: #1f2937; /* gray-800 */
            overscroll-behavior: none;
            min-height: 100vh;
        }

        /* * 左上角作者資訊 (豎排):
         * NEW: 縮小字體。
         */
        .author-watermark {
            position: fixed;
            top: 1rem;
            left: 1rem;
            font-size: 1rem; /* NEW: 1rem (原 1.25rem) */
            font-weight: 900;
            color: #9ca3af; /* gray-400 */
            opacity: 0.8;
            z-index: 50;
            writing-mode: vertical-rl;
            text-orientation: mixed-sideways;
            white-space: nowrap;
            @media (max-width: 640px) {
                font-size: 0.875rem; /* 14px */
                top: 0.5rem;
                left: 0.5rem;
            }
        }

        /* * 浮水印 (斜的蘋果咬一口):
         */
        body::after {
            content: "蘋果咬一口";
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 14vw;
            font-weight: 900;
            color: #9ca3af; /* gray-400 */
            opacity: 0.1;
            z-index: 100;
            pointer-events: none;
            white-space: nowrap;
        }
        
        /* * 主要容器 (卡片):
         * NEW: 減少內外邊距，更緊湊。
         */
        .main-card {
            background-color: #ffffff;
            border-radius: 1.5rem; /* 24px */
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.2), 0 8px 8px -5px rgba(0, 0, 0, 0.05); /* 陰影調整 */
            width: 100%;
            max-width: 40rem; /* 640px */
            padding: 1.5rem; /* NEW: 24px (原 2rem/32px) */
            margin: 1rem auto; /* NEW: 16px (原 2rem/32px) */
            @media (min-width: 640px) {
                padding: 2rem; /* 32px (桌機版恢復) */
                margin: 2rem auto;
            }
        }

        /* * 動畫與高亮
         */
        .highlight {
            border-width: 3px;
            animation: pulse-shadow 1.2s infinite cubic-bezier(0.4, 0, 0.6, 1);
        }
        @keyframes hole-pop-in {
            0% { opacity: 0; transform: scale(0.8); }
            100% { opacity: 1; transform: scale(1); }
        }
        .hole-pop-in {
            animation: hole-pop-in 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            opacity: 0;
        }
        @keyframes stamp-in {
            0% { transform: scale(0.5) rotate(-15deg); opacity: 0; }
            80% { transform: scale(1.1) rotate(5deg); opacity: 1; }
            100% { transform: scale(1) rotate(0deg); opacity: 1; }
        }
        .stamp-in {
            animation: stamp-in 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes pulse-shadow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0.7); }
            50% { box-shadow: 0 0 20px 8px rgba(250, 204, 21, 0.3); }
        }
        @keyframes text-pop {
            0% { opacity: 0; transform: translateY(10px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        .text-pop {
            animation: text-pop 0.3s ease-out;
        }

        /* * 品質徽章 (衝擊性):
         * NEW: 縮小字體和高度。
         */
        .quality-badge {
            font-size: 8rem; /* NEW: 128px (原 10rem) */
            font-weight: 800;
            line-height: 1;
            text-shadow: 0 4px 10px rgba(0,0,0,0.1);
            @media (max-width: 640px) {
                font-size: 7rem; /* NEW: 112px (原 8rem) */
            }
        }
        .quality-s { color: #f59e0b; }
        .quality-a { color: #ec4899; }
        .quality-b { color: #3b82f6; }
        .quality-c { color: #6b7280; }

        /* * 鑄魂洞樣式 (字大, 易讀):
         * NEW: 縮小高度和字體。
         */
        .hole-item {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 5rem; /* NEW: 80px (原 6rem) */
            padding: 0.5rem;
            border-radius: 1rem;
            font-size: 1rem; /* NEW: 15px (原 1.125rem) */
            font-weight: 700;
            border-width: 2px; /* NEW: 2px (原 3px) */
            color: white;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
            @media (max-width: 640px) {
                height: 4.5rem; /* NEW: 72px (原 5rem) */
                font-size: 0.9rem; /* 13.5px */
            }
        }
        .hole-item.text-gray-900 {
            color: #1f2937;
            text-shadow: none;
        }

        /* * 按鈕樣式 (大, 易讀, 衝擊性):
         * NEW: 縮小字體和內邊距。
         */
        .btn-base {
            font-weight: 700;
            padding: 0.625rem 0.5rem; /* NEW: 10px (原 0.75rem/12px) */
            border-radius: 0.75rem;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 1rem; /* NEW: 15px (原 1.125rem) */
            @media (max-width: 380px) {
                font-size: 0.875rem; /* 14px on very small phones */
            }
        }
        .btn-primary {
            background-image: linear-gradient(to right, #4f46e5, #7c3aed);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3), 0 2px 4px -1px rgba(79, 70, 229, 0.2);
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 12px -3px rgba(79, 70, 229, 0.4), 0 4px 6px -2px rgba(79, 70, 229, 0.3);
        }
        .btn-secondary {
            background-color: #d1d5db;
            color: #374151;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }
        .btn-secondary:hover {
            background-color: #b0b5bd;
            transform: translateY(-1px);
        }

        /* * 統計區塊標題 (字大, 易讀):
         * NEW: 縮小字體和下邊距。
         */
        .section-title {
            font-size: 1.25rem; /* NEW: 20px (原 1.5rem) */
            font-weight: 800;
            text-align: center;
            color: #111827;
            margin-bottom: 0.75rem; /* NEW: 12px (原 1rem) */
        }

        /* * NEW: 倉儲分頁系統
         * NEW: 縮小字體。
         */
        .tab-button {
            padding: 0.5rem 0.75rem; /* 減少 padding */
            font-size: 1rem; /* NEW: 15px (原 1.125rem) */
            font-weight: 700;
            color: #6b7280;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .tab-button.active {
            color: #4f46e5;
            border-bottom-color: #4f46e5;
        }
        .tab-panel {
            display: none;
            padding-top: 0.75rem; /* 減少 padding */
        }
        .tab-panel.active {
            display: block;
            animation: text-pop 0.3s ease-out;
        }


        /* * NEW: 鑄魂紀錄 (倉儲) 面板:
         * NEW: 縮小字體和內邊距。
         */
        .stats-stock-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        .stats-stock-table th, .stats-stock-table td {
            padding: 0.5rem 0.25rem; /* NEW: 8px 4px (原 0.75rem 0.5rem) */
            text-align: center;
            font-size: 0.9375rem; /* NEW: 14px (原 1.125rem) */
            word-wrap: break-word;
            /* 手機上 */
            @media (max-width: 640px) {
                font-size: 0.8125rem; /* NEW: 13px (原 0.875rem) */
                padding: 0.5rem 0.125rem; /* 8px 2px */
            }
        }
        /* 表頭 (低飽和) */
        .stats-stock-table th {
            background-color: #e5e7eb;
            color: #4b5563;
            font-weight: 700;
        }
        /* 品質標籤 (S/A/B/C) 或 套裝標籤 */
        .stats-stock-table td:first-child {
            font-weight: 900;
            font-size: 1rem; /* NEW: 15px (原 1.25rem) */
            width: 3rem; /* 48px */
            /* 手機上 */
            @media (max-width: 640px) {
                font-size: 0.875rem; /* 14px */
                font-weight: 700;
                width: 2.75rem; /* 44px */
            }
        }
        /* NEW: 套裝統計表的第一欄 (文字) */
        .type-stats-table td:first-child {
            font-size: 0.9375rem; /* NEW: 14px (原 1rem) */
            text-align: left;
            padding-left: 0.5rem;
            width: auto;
            /* 手機上 */
            @media (max-width: 640px) {
                font-size: 0.8125rem; /* 13px */
            }
        }
        /* 統計數字 */
        .stats-stock-table td {
            font-weight: 600;
            color: #374151;
            min-width: 2rem; /* 32px */
        }
        .stats-stock-table tr:nth-child(even) {
            background-color: #f9fafb;
        }
        .stats-stock-table .impossible {
            color: #d1d5db;
            font-weight: 500;
        }
        /* 圓角 */
        .stats-stock-table th:first-child { border-top-left-radius: 0.75rem; }
        .stats-stock-table th:last-child { border-top-right-radius: 0.75rem; }
        .stats-stock-table tr:last-child td:first-child { border-bottom-left-radius: 0.75rem; }
        .stats-stock-table tr:last-child td:last-child { border-bottom-right-radius: 0.75rem; }

    </style>
</head>
<body class="p-2 md:p-4"> <!-- NEW: 減少 body padding -->

    <!-- 作者資訊 (豎排) -->
    <div class="author-watermark">
        蘋果咬一口
    </div>

    <!-- 主要卡片 -->
    <div class="main-card space-y-4"> <!-- NEW: space-y-4 (原 6) -->
        
        <!-- 標題 -->
        <div class="text-center">
            <h1 class="text-3xl font-black text-gray-900">紋章鑄魂系統模擬</h1> <!-- NEW: text-3xl (原 4xl) -->
            <p class="text-base text-gray-500 mt-1">龍之谷 經典再現</p> <!-- NEW: text-base (原 lg) -->
        </div>

        <!-- 規則說明 -->
        <div class="bg-gray-50 p-4 rounded-xl text-sm text-gray-600 space-y-1 border border-gray-200"> <!-- NEW: p-4, text-sm, space-y-1 -->
            <h3 class="text-lg font-bold text-gray-800 mb-2">模擬規則</h3> <!-- NEW: text-lg (原 xl) -->
            <p>1. 模擬品質 (<span class="text-amber-500 font-bold">S</span>/<span class="text-pink-500 font-bold">A</span>/<span class="text-blue-500 font-bold">B</span>/<span class="text-gray-500 font-bold">C</span>) 決定鑄魂洞數 (5/4/3/2)。</p>
            <p>2. 洞數中 <span class="text-yellow-600 font-bold">數量最多</span> 的類型為「最終判定」。</p>
            <p>3. 若數量相同，以 <span class="text-yellow-600 font-bold">最先出現</span> 的類型為準。</p>
        </div>

        <!-- 操作按鈕 (NEW: 3x2 網格) -->
        <div class="grid grid-cols-3 gap-2 pt-1"> <!-- NEW: gap-2 -->
            <button id="roll-button-1" data-roll-count="1" class="btn-base btn-primary shadow-lg">
                x1
            </button>
            <button id="roll-button-10" data-roll-count="10" class="btn-base btn-primary">
                x10
            </button>
            <button id="roll-button-100" data-roll-count="100" class="btn-base btn-primary">
                x100
            </button>
            <button id="roll-button-1000" data-roll-count="1000" class="btn-base btn-primary">
                x1000
            </button>
            <button id="roll-button-10000" data-roll-count="10000" class="btn-base btn-primary">
                x10000
            </button>
            <button id="reset-button" class="btn-base btn-secondary">
                重置
            </button>
        </div>

        <!-- 結果顯示 (NEW: 壓縮高度) -->
        <div class="pt-2 h-32 relative flex items-center justify-start"> <!-- NEW: pt-2, h-32 (原 pt-4, h-36) -->
            
            <!-- 品質徽章 -->
            <div id="quality-badge" class="quality-badge flex-shrink-0 w-32 text-center transition-opacity duration-500 opacity-0"> <!-- NEW: w-32 (原 w-40) -->
                <!-- S, A, B, C -->
            </div>
            
            <!-- 最終判定 -->
            <div class="flex-grow pl-2 md:pl-4 text-left"> <!-- NEW: pl-2 -->
                <h3 id="summary-title" class="text-4xl sm:text-5xl font-black text-gray-900 transition-opacity duration-500 opacity-0"> <!-- NEW: text-4xl/5xl (原 5xl/6xl) -->
                    —
                </h3>
                <p id="summary-text" class="text-2xl text-yellow-500 font-bold transition-opacity duration-500 opacity-0"> <!-- NEW: text-2xl (原 3xl) -->
                    請點擊按鈕開始
                </p>
            </div>
        </div>

        <!-- 鑄魂洞容器 -->
        <div class="pt-2"> <!-- NEW: pt-2 (原 pt-4) -->
            <div id="results-container" class="grid grid-cols-1 gap-3 text-center min-h-[5rem] items-center"> <!-- NEW: gap-3, min-h-[5rem] -->
                <!-- 初始佔位符 -->
                <div class="h-20 flex items-center justify-center text-gray-400 text-lg font-medium"> <!-- NEW: h-20, text-lg -->
                    點擊「開始鑄魂」
                </div>
            </div>
        </div>

        <!-- 累計成本 -->
        <div class="bg-gray-50 p-4 rounded-xl border border-gray-200"> <!-- NEW: p-4 -->
            <h4 class="section-title">累計成本</h4>
            <div class="grid grid-cols-3 gap-2 text-center"> <!-- NEW: gap-2 -->
                <div class="bg-white p-2 rounded-lg shadow-sm border border-gray-200"> <!-- NEW: p-2 -->
                    <span class="block text-xs opacity-70">嘗試次數</span> <!-- NEW: text-xs -->
                    <span id="total-attempts" class="text-xl font-bold text-gray-800">0</span> <!-- NEW: text-xl -->
                </div>
                <div class="bg-white p-2 rounded-lg shadow-sm border border-gray-200">
                    <span class="block text-xs opacity-70">消耗淨魂聖水</span>
                    <span id="total-holy-water" class="text-xl font-bold text-gray-800">0</span>
                </div>
                <div class="bg-white p-2 rounded-lg shadow-sm border border-gray-200">
                    <span class="block text-xs opacity-70">消耗金幣</span>
                    <span id="total-gold" class="text-xl font-bold text-gray-800">0</span>
                </div>
            </div>
        </div>

        <!-- 鑄魂紀錄 (倉儲) -->
        <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-inner"> <!-- NEW: p-4 -->
            <h4 class="section-title">鑄魂紀錄 (倉儲)</h4>
            
            <!-- 分頁按鈕 -->
            <div class="flex border-b border-gray-200">
                <button id="tab-btn-quality" class="tab-button active">品質統計</button>
                <button id="tab-btn-type" class="tab-button">套裝統計</button>
            </div>

            <!-- 品質統計 面板 -->
            <div id="tab-panel-quality" class="tab-panel active">
                <div class="overflow-x-auto">
                    <table class="stats-stock-table quality-stats-table">
                        <thead>
                            <tr>
                                <th>品質</th>
                                <th>次數</th>
                                <th>x2 相同</th>
                                <th>x3 相同</th>
                                <th>x4 相同</th>
                                <th>x5 相同</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- S -->
                            <tr>
                                <td class="quality-s">S</td>
                                <td id="s-attempts">0</td>
                                <td id="s-set-2">0</td>
                                <td id="s-set-3">0</td>
                                <td id="s-set-4">0</td>
                                <td id="s-set-5">0</td>
                            </tr>
                            <!-- A -->
                            <tr>
                                <td class="quality-a">A</td>
                                <td id="a-attempts">0</td>
                                <td id="a-set-2">0</td>
                                <td id="a-set-3">0</td>
                                <td id="a-set-4">0</td>
                                <td class="impossible">—</td>
                            </tr>
                            <!-- B -->
                            <tr>
                                <td class="quality-b">B</td>
                                <td id="b-attempts">0</td>
                                <td id="b-set-2">0</td>
                                <td id="b-set-3">0</td>
                                <td class="impossible">—</td>
                                <td class="impossible">—</td>
                            </tr>
                            <!-- C -->
                            <tr>
                                <td class="quality-c">C</td>
                                <td id="c-attempts">0</td>
                                <td id="c-set-2">0</td>
                                <td class="impossible">—</td>
                                <td class="impossible">—</td>
                                <td class="impossible">—</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 套裝統計 面板 -->
            <div id="tab-panel-type" class="tab-panel">
                <div class="overflow-x-auto">
                    <table class="stats-stock-table type-stats-table">
                        <thead>
                            <tr>
                                <th>套裝類型</th>
                                <th>x2</th>
                                <th>x3</th>
                                <th>x4</th>
                                <th>x5</th>
                            </tr>
                        </thead>
                        <tbody id="type-stats-body">
                            <!-- JS 動態填入 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- 1. DOM 元素與常數定義 ---

        // 核心設定：7 種類型 (NEW: 更新排列順序)
        const POTENTIAL_TYPES = [
            '終結熊', '終結智', '終結風',
            '光暗物', '光暗魔', '水火物', '水火魔'
        ];

        // 視覺化版面設計：為 7 種類型定義顏色 (漸層)
        const TYPE_COLORS = {
            '水火魔': 'bg-gradient-to-br from-cyan-500 to-cyan-700 border-cyan-400',       // 青藍
            '光暗魔': 'bg-gradient-to-br from-purple-700 to-purple-900 border-purple-600',   // 暗紫
            '終結智': 'bg-gradient-to-br from-pink-400 to-pink-600 border-pink-300',     // 粉紫色 (原 終極智)
            '水火物': 'bg-gradient-to-br from-red-500 to-red-700 border-red-400',         // 紅
            '光暗物': 'bg-gradient-to-br from-yellow-400 to-yellow-600 border-yellow-300 text-gray-900', // 黃色
            '終結熊': 'bg-gradient-to-br from-orange-700 to-orange-900 border-orange-600',   // 土色 (原 終極熊)
            '終結風': 'bg-gradient-to-br from-green-700 to-green-900 border-green-600',     // 暗綠 (原 終極風)
        };

        // 成本常數 (聖水 -> 淨魂聖水)
        const COST_PER_ROLL = {
            holyWater: 3,
            gold: 500
        };
        
        // 保底機制
        const PITY_THRESHOLD = 100;
        let pityCounter = 0;

        // 統計變數
        let totalAttempts = 0;
        let totalHolyWater = 0;
        let totalGold = 0;

        // 鑄魂紀錄 (倉儲) 變數 (品質統計)
        let qualityStatisticsStock = {
            S: { attempts: 0, setOf2: 0, setOf3: 0, setOf4: 0, setOf5: 0 },
            A: { attempts: 0, setOf2: 0, setOf3: 0, setOf4: 0 },
            B: { attempts: 0, setOf2: 0, setOf3: 0 },
            C: { attempts: 0, setOf2: 0 }
        };

        // 鑄魂紀錄 (倉儲) 變數 (套裝統計)
        let typeStatisticsStock = {};
        POTENTIAL_TYPES.forEach(type => {
            typeStatisticsStock[type] = { setOf2: 0, setOf3: 0, setOf4: 0, setOf5: 0 };
        });


        // DOM 元素獲取
        const rollButtons = [
            document.getElementById('roll-button-1'),
            document.getElementById('roll-button-10'),
            document.getElementById('roll-button-100'),
            document.getElementById('roll-button-1000'),
            document.getElementById('roll-button-10000'),
        ];
        const resetButton = document.getElementById('reset-button');
        const resultsContainer = document.getElementById('results-container');
        const summaryTitle = document.getElementById('summary-title');
        const summaryText = document.getElementById('summary-text');
        const qualityBadgeEl = document.getElementById('quality-badge');
        
        // 成本元素
        const totalAttemptsEl = document.getElementById('total-attempts');
        const totalHolyWaterEl = document.getElementById('total-holy-water');
        const totalGoldEl = document.getElementById('total-gold');

        // 分頁元素
        const tabBtnQuality = document.getElementById('tab-btn-quality');
        const tabBtnType = document.getElementById('tab-btn-type');
        const tabPanelQuality = document.getElementById('tab-panel-quality');
        const tabPanelType = document.getElementById('tab-panel-type');

        // 品質統計 (倉儲) 元素
        const sAttemptsEl = document.getElementById('s-attempts');
        const sSet2El = document.getElementById('s-set-2');
        const sSet3El = document.getElementById('s-set-3');
        const sSet4El = document.getElementById('s-set-4');
        const sSet5El = document.getElementById('s-set-5');
        const aAttemptsEl = document.getElementById('a-attempts');
        const aSet2El = document.getElementById('a-set-2');
        const aSet3El = document.getElementById('a-set-3');
        const aSet4El = document.getElementById('a-set-4');
        const bAttemptsEl = document.getElementById('b-attempts');
        const bSet2El = document.getElementById('b-set-2');
        const bSet3El = document.getElementById('b-set-3');
        const cAttemptsEl = document.getElementById('c-attempts');
        const cSet2El = document.getElementById('c-set-2');

        // 套裝統計 (倉儲) 元素
        const typeStatsBody = document.getElementById('type-stats-body');


        // --- 2. 核心邏輯實現 ---

        /**
         * 根據機率隨機產生品質和洞數 (含保底機制)
         * C (65%), B (20%), A (13%), S (2%)
         * 保底: 100 抽必 S
         * @returns {object} { quality: 'S'|'A'|'B'|'C', numHoles: 5|4|3|2 }
         */
        function getQualityAndHoles() {
            // 保底計數器 +1
            pityCounter++;

            // 步驟 1: 檢查保底
            if (pityCounter >= PITY_THRESHOLD) {
                pityCounter = 0; // 重置保底
                return { quality: 'S', numHoles: 5 };
            }

            // 步驟 2: 正常擲骰
            const roll = Math.random() * 100;
            
            // S (2%)
            if (roll < 2) { 
                pityCounter = 0; // 重置保底
                return { quality: 'S', numHoles: 5 };
            } 
            // A (13%) (2 + 13 = 15)
            else if (roll < 15) { 
                return { quality: 'A', numHoles: 4 };
            } 
            // B (20%) (15 + 20 = 35)
            else if (roll < 35) { 
                return { quality: 'B', numHoles: 3 };
            } 
            // C (65%) (35 + 65 = 100)
            else {                
                return { quality: 'C', numHoles: 2 };
            }
        }

        /**
         * 模擬一次鑄魂
         * @returns {object} { results: string[], quality: string, numHoles: number }
         */
        function rollPotentials() {
            // 步驟 1: 決定品質和洞數
            const { quality, numHoles } = getQualityAndHoles();

            // 步驟 2: 填滿結果 (只填有洞的)
            const results = [];
            for (let i = 0; i < numHoles; i++) {
                const randomIndex = Math.floor(Math.random() * POTENTIAL_TYPES.length);
                results.push(POTENTIAL_TYPES[randomIndex]);
            }
            
            return { results, quality, numHoles };
        }

        /**
         * 分析結果，找出主要的鑄魂類型
         * @param {string[]} results - 鑄魂結果陣列
         * @returns {object} { dominantType: string | null, count: number }
         */
        function analyzeResults(results) {
            const counts = {};
            const firstAppearance = {};

            results.forEach((type, index) => {
                counts[type] = (counts[type] || 0) + 1;
                if (firstAppearance[type] === undefined) {
                    firstAppearance[type] = index;
                }
            });

            let dominantType = null;
            let maxCount = 0;
            let minIndex = Infinity;

            for (const type of POTENTIAL_TYPES) {
                const count = counts[type] || 0;
                if (count > 0) {
                    if (count > maxCount) {
                        maxCount = count;
                        dominantType = type;
                        minIndex = firstAppearance[type];
                    } 
                    else if (count === maxCount) {
                        if (firstAppearance[type] < minIndex) {
                            dominantType = type;
                            minIndex = firstAppearance[type];
                        }
                    }
                }
            }
            
            if (dominantType === null && results.length > 0) {
                 dominantType = results[0];
                 maxCount = 1;
            }

            return { dominantType, count: maxCount };
        }

        // --- 3. UI 更新函數 ---

        /**
         * 更新 UI 介面以顯示當次結果
         * @param {object} analysisData - 包含所有分析結果的物件
         */
        function updateUI({ dominantType, count, allResults, quality, numHoles }) {
            
            const initialPlaceholder = resultsContainer.querySelector('.text-gray-400');
            if (initialPlaceholder) initialPlaceholder.remove();

            resultsContainer.innerHTML = '';
            
            // 步驟 1 - 設定動態網格佈局
            resultsContainer.className = 'grid gap-3 text-center items-center'; // NEW: gap-3
            if (numHoles === 2) {
                resultsContainer.classList.add('grid-cols-2');
            } else if (numHoles === 3) {
                resultsContainer.classList.add('grid-cols-3');
            } else if (numHoles === 4) {
                resultsContainer.classList.add('grid-cols-4'); // A 改為 4 欄
            } else if (numHoles === 5) {
                resultsContainer.classList.add('grid-cols-5'); // S 改為 5 欄
            }

            // 步驟 2：更新洞的視覺 (交錯動畫)
            allResults.forEach((type, index) => {
                const holeDiv = document.createElement('div');
                const colorClasses = TYPE_COLORS[type];
                const isDominant = (type === dominantType);
                
                holeDiv.className = `hole-item relative ${colorClasses}`;

                const typeName = document.createElement('span');
                typeName.className = "z-10"; 
                typeName.textContent = type;
                holeDiv.appendChild(typeName);

                if (isDominant) {
                    holeDiv.classList.add('highlight');
                }

                holeDiv.style.animationDelay = `${index * 0.05}s`;
                holeDiv.classList.add('hole-pop-in');

                resultsContainer.appendChild(holeDiv);
            });

            // 步驟 3：更新最終判定結果
            if (count === 0) {
                summaryTitle.textContent = '無有效鑄魂'; 
                summaryText.textContent = '最終判定';
            } else {
                summaryTitle.textContent = `${dominantType} x ${count} 洞`;
                summaryText.textContent = '最終判定';
            }

            // 步驟 4 - 更新品質徽章
            qualityBadgeEl.textContent = quality;
            qualityBadgeEl.className = `quality-badge flex-shrink-0 w-32 text-center stamp-in quality-${quality.toLowerCase()}`;
            qualityBadgeEl.classList.remove('opacity-0');

            // 讓結果文字彈入
            summaryTitle.classList.add('text-pop');
            summaryText.classList.add('text-pop');
            summaryTitle.classList.remove('opacity-0');
            summaryText.classList.remove('opacity-0');

            // 步驟 5：更新按鈕文字 (引導使用者再次操作)
            // (多抽按鈕不需要更新)
        }

        /**
         * 更新統計數據 (成本) 的 UI
         */
        function updateCostStatsUI() {
            totalAttemptsEl.textContent = totalAttempts.toLocaleString();
            totalHolyWaterEl.textContent = totalHolyWater.toLocaleString();
            totalGoldEl.textContent = totalGold.toLocaleString();
        }

        /**
         * 更新 "品質統計" (倉儲) 的 UI
         */
        function updateQualityStatisticsStockUI() {
            // S (5 洞)
            sAttemptsEl.textContent = qualityStatisticsStock.S.attempts.toLocaleString();
            sSet2El.textContent = qualityStatisticsStock.S.setOf2.toLocaleString();
            sSet3El.textContent = qualityStatisticsStock.S.setOf3.toLocaleString();
            sSet4El.textContent = qualityStatisticsStock.S.setOf4.toLocaleString();
            sSet5El.textContent = qualityStatisticsStock.S.setOf5.toLocaleString();
            // A (4 洞)
            aAttemptsEl.textContent = qualityStatisticsStock.A.attempts.toLocaleString();
            aSet2El.textContent = qualityStatisticsStock.A.setOf2.toLocaleString();
            aSet3El.textContent = qualityStatisticsStock.A.setOf3.toLocaleString();
            aSet4El.textContent = qualityStatisticsStock.A.setOf4.toLocaleString();
            // B (3 洞)
            bAttemptsEl.textContent = qualityStatisticsStock.B.attempts.toLocaleString();
            bSet2El.textContent = qualityStatisticsStock.B.setOf2.toLocaleString();
            bSet3El.textContent = qualityStatisticsStock.B.setOf3.toLocaleString();
            // C (2 洞)
            cAttemptsEl.textContent = qualityStatisticsStock.C.attempts.toLocaleString();
            cSet2El.textContent = qualityStatisticsStock.C.setOf2.toLocaleString();
        }

        /**
         * 更新 "套裝統計" (倉儲) 的 UI
         */
        function updateTypeStatisticsStockUI() {
            POTENTIAL_TYPES.forEach(type => {
                const stats = typeStatisticsStock[type];
                document.getElementById(`type-${type}-set2`).textContent = stats.setOf2.toLocaleString();
                document.getElementById(`type-${type}-set3`).textContent = stats.setOf3.toLocaleString();
                document.getElementById(`type-${type}-set4`).textContent = stats.setOf4.toLocaleString();
                document.getElementById(`type-${type}-set5`).textContent = stats.setOf5.toLocaleString();
            });
        }
        
        /**
         * 首次初始化 "套裝統計" 表格
         */
        function initializeTypeStatsTable() {
            typeStatsBody.innerHTML = ''; // 清空
            POTENTIAL_TYPES.forEach(type => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="font-bold text-left pl-2">${type}</td>
                    <td id="type-${type}-set2">0</td>
                    <td id="type-${type}-set3">0</td>
                    <td id="type-${type}-set4">0</td>
                    <td id="type-${type}-set5">0</td>
                `;
                typeStatsBody.appendChild(row);
            });
        }


        // --- 4. 事件處理函數 ---

        /**
         * 處理「多抽」按鈕點擊
         */
        function handleMultiRollClick(event) {
            const rollCount = parseInt(event.currentTarget.dataset.rollCount, 10);
            if (isNaN(rollCount) || rollCount <= 0) return;

            // 隱藏上一次的徽章和文字，準備動畫
            qualityBadgeEl.classList.add('opacity-0');
            summaryTitle.classList.add('opacity-0');
            summaryText.classList.add('opacity-0');
            summaryTitle.classList.remove('text-pop');
            summaryText.classList.remove('text-pop');
            
            // 禁用按鈕防止連點
            rollButtons.forEach(btn => btn.disabled = true);
            resetButton.disabled = true;

            let lastRollData = {};

            // 執行 N 次模擬 (在 JS 內循環)
            for (let i = 0; i < rollCount; i++) {
                // 累加成本
                totalAttempts++;
                totalHolyWater += COST_PER_ROLL.holyWater;
                totalGold += COST_PER_ROLL.gold;

                // 1. 模擬
                const { results, quality, numHoles } = rollPotentials();
                
                // 2. 分析
                const { dominantType, count } = analyzeResults(results);

                // 3. 更新品質統計 (總次數)
                qualityStatisticsStock[quality].attempts++;
                
                // 4. 更新兩種鑄魂紀錄
                if (count >= 2) {
                    const qualityKey = quality;
                    const setKey = `setOf${count}`;
                    
                    // 4a. 更新品質統計 (相同)
                    if (qualityStatisticsStock[qualityKey][setKey] !== undefined) {
                        qualityStatisticsStock[qualityKey][setKey]++;
                    }
                    
                    // 4b. 更新套裝統計
                    if (dominantType && typeStatisticsStock[dominantType][setKey] !== undefined) {
                        typeStatisticsStock[dominantType][setKey]++;
                    }
                }

                // 儲存最後一次的結果，用於顯示
                if (i === rollCount - 1) {
                    lastRollData = { dominantType, count, allResults: results, quality, numHoles };
                }
            }
            
            // 5. 更新統計 UI (一次性)
            updateCostStatsUI();
            updateQualityStatisticsStockUI();
            updateTypeStatisticsStockUI();

            // 6. 更新主要結果 UI (只顯示最後一次)
            setTimeout(() => {
                updateUI(lastRollData);
                // 恢復按鈕
                rollButtons.forEach(btn => btn.disabled = false);
                resetButton.disabled = false;
            }, 50); // 縮短延遲
        }

        /**
         * 處理「重置統計」按鈕點擊
         */
        function resetStats() {
            // 重置所有變數
            totalAttempts = 0;
            totalHolyWater = 0;
            totalGold = 0;
            pityCounter = 0; // 重置保底
            
            // 重置品質統計
            qualityStatisticsStock = {
                S: { attempts: 0, setOf2: 0, setOf3: 0, setOf4: 0, setOf5: 0 },
                A: { attempts: 0, setOf2: 0, setOf3: 0, setOf4: 0 },
                B: { attempts: 0, setOf2: 0, setOf3: 0 },
                C: { attempts: 0, setOf2: 0 }
            };
            
            // 重置套裝統計
            typeStatisticsStock = {};
            POTENTIAL_TYPES.forEach(type => {
                typeStatisticsStock[type] = { setOf2: 0, setOf3: 0, setOf4: 0, setOf5: 0 };
            });

            // 更新統計 UI
            updateCostStatsUI();
            updateQualityStatisticsStockUI();
            updateTypeStatisticsStockUI();
            
            // 恢復初始 UI 狀態
            summaryTitle.textContent = '—';
            summaryText.textContent = '請點擊按鈕開始';
            summaryTitle.classList.add('opacity-0');
            summaryText.classList.add('opacity-0');
            qualityBadgeEl.classList.add('opacity-0');

            // 清空結果
            resultsContainer.innerHTML = `
                <div class="h-20 flex items-center justify-center text-gray-400 text-lg font-medium">
                    點擊「開始鑄魂」
                </div>
            `;
            resultsContainer.className = 'grid grid-cols-1 gap-3 text-center min-h-[5rem] items-center';
            
            // 重設分頁到第一個
            tabBtnQuality.click();
        }

        /**
         * 處理分頁切換
         */
        function handleTabClick(event) {
            tabBtnQuality.classList.remove('active');
            tabBtnType.classList.remove('active');
            tabPanelQuality.classList.remove('active');
            tabPanelType.classList.remove('active');

            const clickedButton = event.currentTarget;
            clickedButton.classList.add('active');

            if (clickedButton.id === 'tab-btn-quality') {
                tabPanelQuality.classList.add('active');
            } else if (clickedButton.id === 'tab-btn-type') {
                tabPanelType.classList.add('active');
            }
        }

        // --- 5. 啟動器 ---
        rollButtons.forEach(btn => {
            btn.addEventListener('click', handleMultiRollClick);
        });
        resetButton.addEventListener('click', resetStats);
        
        tabBtnQuality.addEventListener('click', handleTabClick);
        tabBtnType.addEventListener('click', handleTabClick);

        // 頁面載入時
        initializeTypeStatsTable(); // 產生套裝表格
        updateQualityStatisticsStockUI(); // 初始化品質表格 (顯示 0)
        updateTypeStatisticsStockUI(); // 初始化套裝表格 (顯示 0)

    </script>
</body>
</html>



